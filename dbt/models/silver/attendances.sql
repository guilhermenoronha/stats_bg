WITH 

ATTENDANCES AS (SELECT * FROM {{ source('bronze', 'ATTENDANCES') }}),
PLAYERS AS (SELECT * FROM {{ source('bronze', 'PLAYERS') }}),

STEP_0 AS (
    SELECT
        TO_DATE(A."DATE", '%dd%mm%YY') AS DATE,
        A."PLAYER_ID"::INT AS PLAYER_ID,
        P."NAME"::VARCHAR AS PLAYER_NAME,
        A."IS_HOST"::BOOLEAN AS IS_HOST
    FROM ATTENDANCES A
    LEFT JOIN PLAYERS P ON A."PLAYER_ID" = P."ID"
),

FINAL AS (
    SELECT 
        S.*,
        CASE WHEN (S.PLAYER_ID - LAG(S.PLAYER_ID, 1) OVER (ORDER BY DATE)) != 0 THEN TRUE ELSE FALSE END AS IS_HOST_CHANGED
    FROM STEP_0 S
)

SELECT * FROM FINAL